define(["ojs/ojcontext","knockout","jquery","ojs/ojarraydataprovider","./equivalences/scalesEquivalences","./utils/utils","ojs/ojcolor","htmlToImage","downloadjs","./utils/exportImageUtils","ojs/ojknockout","ojs/ojinputtext","ojs/ojinputnumber","ojs/ojselectsingle","oj-c/buttonset-single","oj-c/button","oj-c/popup","ojs/ojchart","ojs/ojcolorspectrum","oj-c/message-toast","./components/graphs-templates/loader","./components/draggable-categories/loader","./components/reference-areas/loader","oj-c/collapsible"],(function(e,t,a,o,r,s,i,l,h,n){function p(){this._initializeVars(),this._initializeDP(),this._initializeListeners(),this._showReleaseNews()}return p.prototype._initializeVars=function(){this.graphId="nkiGraph__chart",this.graphSectionId="nkiGraph__chart-section",this.htmlToImageOptimizerID="nkiGraphs__html-to-image-dummy",this.graphCategories=t.observableArray([s.getGraphCatModel()]),this.chartData=t.observableArray([]),this.maxY=t.observable(100),this.stepY=t.observable(10),this.legendPosition=t.observable("bottom"),this.chartType=t.observable("polar"),this.curIdx=t.observable(),this.curCategoryName=t.observable(),this.curColorSelected=t.observable(),this.labelPosition=t.observable("auto"),this.chartOrientation=t.observable("vertical"),this.templateApplied=t.observable(!1),this.templateAppliedName=t.observable(""),this.graphSettingsOpened=t.observable(!1),this.btnOpenGraphSettingsId="btnOpenGraphSettings",this.categoryFormOpened=t.observable(!1),this.curCategoryNameToUpdate=t.observable(),this.curCategoryValueToUpdate=t.observable(),this.curCategoryColorToUpdate=t.observable(),this.curCategoryScaleToUpdate=t.observable(),this.curCategoryIdToUpdate=t.observable(),this.curCategoryPeScaleToUpdate=t.observable(),this.curColorAuxiliar=t.observable(),this.colorInputErrorMessage=t.observable(""),this.toastMessages=t.observableArray([]),this.inputTextTranslations=s.INPUT_TEXT_TRANSLATIONS,this.editCategoryErrorMessage=t.observable(""),this.referenceAreas=t.observableArray([]),this.yReferenceObjects=t.computed((function(){const e=this.referenceAreas();return s.getReferenceObjects(e)}),this),this.currentReleaseComplete=`v${s.CURRENT_RELEASE_COMPLETE}`,this.labelNoData=s.CHART_TRANSLATIONS.labelNoData,this._isExportImageProcessing=t.observable(!1)},p.prototype._initializeDP=function(){this.scalesDp=new o(r.SCALES_LOV,{keyAttributes:"value"}),this.scalesObject=r.SCALES_LOV.reduce(((e,t)=>({...e,[t.value]:t.label})),{}),this.chartTypeOptions=[{label:"Bar",value:"cartesian"},{label:"Polar",value:"polar"}],this.labelPositionOptions=[{label:"Ver",value:"auto"},{label:"Ocultar",value:"none"}],this.orientationOptions=[{label:"Vertical",value:"vertical"},{label:"Horizontal",value:"horizontal"}],this.legendPositionDp=new o([{value:"start",label:"Izquierda"},{value:"end",label:"Derecha"},{value:"bottom",label:"Abajo"},{value:"top",label:"Arriba"}],{keyAttributes:"value"}),this.chartDataDp=new o(this.chartData,{keyAttributes:"id"}),this.toastMessagesDP=new o(this.toastMessages,{keyAttributes:"id"})},p.prototype._initializeListeners=function(){this.handleGraph=()=>this._refreshGraph(),this.handleCatValueChanged=()=>{this.curCategoryPeScaleToUpdate(this._convertToPercentile(this.curCategoryValueToUpdate(),this.curCategoryScaleToUpdate()))},this.closeToastMessage=e=>{this._deleteToastMessage(e.detail.key)},this.handleAddCategory=()=>{this._addCategory()},this.handleRemoveCategory=(e,t)=>{this._deleteCategory(t.id)},this.handleGetCurrentGraph=()=>this._getCurrentGraph(),this.handleApplyGraph=(e,t)=>this._applyGraph(e,t),this.handleGraphSaved=e=>{this.templateApplied(!0),this.templateAppliedName(e.name)},this.handleItemDrilling=e=>{this._prepareEditCategory(e.detail.data.itemData)},this.handleEditCategory=(e,t)=>{this._prepareEditCategory(t)},this.handleSaveEditCategory=()=>{this._editCategory()},this.handleCategoriesOnSortEnd=e=>this._handleCategoriesSorting(e),this.handleColorInputTextChange=e=>{try{const e=this.curColorAuxiliar();if(e){const t=new i(e);this.curCategoryColorToUpdate(t),this.colorInputErrorMessage("")}}catch(e){this.colorInputErrorMessage("Color InvÃ¡lido"),this.curCategoryColorToUpdate("")}},this.handleColorSpectrumChange=e=>{this.curColorAuxiliar(this.curCategoryColorToUpdate().toString())},this.exportImage=e=>{e.preventDefault(),this._exportImage()}},p.prototype._getCurrentGraph=function(){return{categories:this.graphCategories().map((e=>s.getGraphCatModel(e))),graphSettings:{maxY:this.maxY(),stepY:this.stepY(),legendPosition:this.legendPosition(),chartType:this.chartType(),chartOrientation:this.chartOrientation(),labelPosition:this.labelPosition(),referenceAreas:this.referenceAreas()}}},p.prototype._applyGraph=function(e,t){this.templateApplied(!0),this.templateAppliedName(e);const{graphSettings:a,categories:o}=t;if(void 0===a||void 0===o)return;this.maxY(a.maxY),this.stepY(a.stepY),this.legendPosition(a.legendPosition),this.chartType(a.chartType),this.chartOrientation(a.chartOrientation),this.labelPosition(a.labelPosition),this.referenceAreas(a.referenceAreas??[]);const r=o.map((e=>{const t=s.getGraphCatModel();return t.name=e.name,t.value=e.value,t.scale=e.scale,t.peScale=e.peScale,t.color=e.color,t}));this.graphCategories(r),this._refreshGraph()},p.prototype._handleCategoriesSorting=function(e){const t=e.oldDraggableIndex,a=e.newDraggableIndex;if(t===a)return;const o=this.graphCategories(),r=o.splice(t,1)[0];this._deleteCategoryCardFromDOM(r.id),o.splice(a,0,r),this.graphCategories([...o]),this._refreshGraph()},p.prototype._deleteCategoryCardFromDOM=function(e){const t=a(`#${e}`);t.length>0&&t.remove()},p.prototype._convertToPercentile=function(e,t){return""!==e&&t?r.transformScaleToPercentile(e,t):null},p.prototype._addToastMessage=function(e){this.toastMessages.push({...e,id:crypto.randomUUID()})},p.prototype._deleteToastMessage=function(e){this.toastMessages.remove((t=>t.id===e))},p.prototype._deleteCategory=function(e){this.graphCategories.remove((t=>t.id===e)),this._refreshGraph()},p.prototype._refreshGraph=function(){const e=this.graphCategories().map((e=>s.getDataItemForChart(e)));this.chartData(e)},p.prototype._addCategory=function(e=void 0){if(this.graphCategories().length===s.CATEGORIES_VALIDATIONS.MAX_NUMBER_OF_CATEGORIES)return void this._addToastMessage({severity:"warning",summary:s.CATEGORIES_VALIDATIONS.ON_MAX_SUMMARY,detail:s.CATEGORIES_VALIDATIONS.ON_MAX_DETAIL,autoTimeout:s.TOAST_MESSAGES_AUTO_TIMEOUT_MS});const t=s.getGraphCatModel(e);this.graphCategories.push(t),this._prepareEditCategory(t)},p.prototype._prepareEditCategory=function(e){this.curCategoryIdToUpdate(e.id),this.curCategoryNameToUpdate(e.name),this.curCategoryValueToUpdate(e.value),this.curCategoryScaleToUpdate(e.scale),this.curCategoryPeScaleToUpdate(e.peScale);const t=e.color?new i(e.color):"";this.curCategoryColorToUpdate(t),this.curColorAuxiliar(t.toString()),this.colorInputErrorMessage(""),this.categoryFormOpened(!0)},p.prototype._editCategory=function(){const e=this.curCategoryIdToUpdate(),t=this.curCategoryNameToUpdate(),a=this.curCategoryValueToUpdate(),o=this.curCategoryScaleToUpdate(),r=this.curCategoryPeScaleToUpdate(),i=this.curCategoryColorToUpdate()?this.curCategoryColorToUpdate().toString():"";if(!t||""===a||!o)return void this.editCategoryErrorMessage(s.EDIT_CAT_ERROR_MESSAGE);this.editCategoryErrorMessage();const l=this.graphCategories().find((t=>t.id===e)),h=s.getGraphCatModel({name:t,value:a,scale:o,peScale:r,color:i,id:e});this.graphCategories.replace(l,h),this.categoryFormOpened(!1),this._refreshGraph()},p.prototype._showReleaseNews=function(){const e=s.getReleaseNews();e&&this._addToastMessage({...e})},p.prototype._exportImage=async function(){if(this._isExportImageProcessing())this._addToastMessage(n.TOAST_MESSAGE_IMAGE_PROCESSING);else try{this._isExportImageProcessing(!0),this._addToastMessage(n.TOAST_MESSAGE_PREPARING_IMAGE);const e=await l.toBlob(document.getElementById(this.graphSectionId),{pixelRatio:1,cacheBust:!0,skipFonts:!1});this._addToastMessage(n.TOAST_MESSAGE_DOWNLOADING_IMAGE);const t=n.getFileName(this.templateAppliedName());h(e,t,"image/png")}catch(e){this._addToastMessage(n.TOAST_MESSAGE_ERROR),console.error("Error while creating image",e)}finally{this._isExportImageProcessing(!1)}},e.getPageContext().getBusyContext().applicationBootstrapComplete(),new p}));