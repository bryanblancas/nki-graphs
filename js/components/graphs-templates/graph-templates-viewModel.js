define(["ojs/ojcontext","knockout","jquery","./graph-templates-utils","../../utils/utils","ojs/ojarraydataprovider","ojs/ojchart","oj-c/popup","ojs/ojinputtext","ojs/ojselectsingle","oj-c/menu-button","oj-c/file-picker"],(function(t,e,s,r,i,a){function o(t){this.properties=t.properties,this._initState(),this._defineAuxiliars(),this._defineHandlers()}return o.prototype._initState=function(){this.saveTmplBtnId="saveChartTmplBtn",this.saveTmplModalId="saveChartTmplModal",this.applyTmplBtnId="applyChartTmplBtn",this.applyTmplModalId="applyChartTmplModal",this.saveTmplOpened=e.observable(!1),this.applyTmplOpened=e.observable(!1),this.chartTmplName=e.observable(""),this.chartTmplDesc=e.observable(""),this.showError=e.observable(!1),this.errorMessage=e.observable(""),this.selectedChart=e.observable(null),this.selectedChartObj=e.observable(null),this.templates=e.observableArray([]),this.importTmplsOpened=e.observable(!1),this.fileUploadStatus=e.observable(""),this.fileSummary=e.observable({}),this.isValidFile=e.observable(!1),this._fileData=e.observable(null),this.templatesDP=new a(this.templates,{keyAttributes:"name"}),this.inputTextTranslations=i.INPUT_TEXT_TRANSLATIONS,this.labelNoData=i.CHART_TRANSLATIONS.labelNoData,this.miniChartData=e.observableArray([]),this.miniChartDataDp=new a(this.miniChartData,{keyAttributes:"id"}),this.templatesOptions=e.observableArray([{label:"Exportar Gráficos",key:"exportTemplates"},{label:"Importar Gráficos",key:"importTemplates"}]),this.optionsState=e.observable({text:"",type:"info"})},o.prototype._defineAuxiliars=function(){this._preventDefault=t=>t.detail?.originalEvent?.preventDefault(),this._getChartTemplFromName=t=>{const e=this.templates().findIndex((e=>e.name===t));if(e>-1){const t=this.templates()[e];return t.index=e,t}return null}},o.prototype._defineHandlers=function(){this.handleApplyTmplOpened=()=>{this.optionsState({text:"",type:"info"})},this.handleSaveChartTmplClick=t=>{this._preventDefault(t),this._saveChartTmpl()},this.handleOpenApplyTmplModal=t=>{this._preventDefault(t),this._bindTemplates(),this._setState({showError:!1,errorMessage:""}),this.applyTmplOpened(!0)},this.handleSelectedChartChange=()=>{this._setState({showError:!1,errorMessage:""});const t=this.selectedChart();this.selectedChartObj(this._getChartTemplFromName(t)),this.miniChartData(r.MINI_GRAPH_PREVIEW_PROPERTIES.getChartData(this.selectedChartObj()))},this.handleApplyChartTmplClick=t=>{this._preventDefault(t),this._applyChartTempl()},this.handleRemoveChartTmplClick=t=>{this._preventDefault(t),this._removeChartTmpl()},this.MiniGraphPreviewProperties=r.MINI_GRAPH_PREVIEW_PROPERTIES,this.handleOptionClick=async t=>{if("exportTemplates"===t.detail.key)try{await r.exportTemplates()}catch(t){console.error("An error has occurred while exporting templates",t),this.optionsState({text:"Ocurrió un error al exportar los gráficos",type:"error"})}else this.importTmplsOpened(!0)},this.handleImportTmplsOpened=()=>{this.fileUploadStatus(""),this.isValidFile(!1)},this.handleFileSelect=t=>{const e=t.detail.files;this._readFile(e[0])},this.handleApplyImport=t=>{this._importTemplates()}},o.prototype._saveChartTmpl=function(){this._setState({showError:!1});const t=this.chartTmplName(),e=this.chartTmplDesc();if(!this._canSaveCurrentChartTmpl(t,e))return void this._setState({showError:!0,errorMessage:"Por favor, completa el formulario"});const s={name:t,description:e,chartData:this.properties.getCurrentChart()},i=r.saveChartTemplate(s);!0===i?(this.saveTmplOpened(!1),this.chartTmplName(),this.chartTmplDesc(),this.properties.onChartSaved(s)):this._setState({showError:!0,errorMessage:i})},o.prototype._setState=function({showError:t,errorMessage:e}){void 0!==t&&this.showError(t),void 0!==e&&this.errorMessage(e)},o.prototype._canSaveCurrentChartTmpl=function(t,e){return!!t&&!("string"==typeof e&&e.length>200)},o.prototype._bindTemplates=function(){const t=r.getChartTemplates()||[];this.templates(t)},o.prototype._applyChartTempl=function(){const t=this.selectedChartObj();t?(this.properties.applyChartTemplate(t.name,t.chartData),this.selectedChart(null),this.selectedChartObj(null),this.applyTmplOpened(!1)):this._setState({showError:!0,errorMessage:"Selecciona un gráfico"})},o.prototype._removeChartTmpl=function(){const t=this.selectedChartObj();if(!t)return void this._setState({showError:!0,errorMessage:"Selecciona un gráfico"});const e=t.index;this.templates.remove((t=>t.index===e));!0!==r.saveChartTemplates(this.templates())&&this._setState({showError:!0,errorMessage:"Hubo un error al eliminar el gráfico."})},o.prototype._readFile=async function(t){if(!t||"application/json"!==t.type)return this.fileUploadStatus("Tipo de archivo inválido. Sólo un archivo .json es permitido."),void this.isValidFile(!1);const e=await r.getFileContent(t),s=JSON.parse(e);if(!await r.isValidFileContent(s))return this.fileUploadStatus("El archivo está corrupto. No es posible importar los gráficos."),void this.isValidFile(!1);this._fileData(s),this.fileSummary(r.generateFileSummary(s)),this.isValidFile(!0)},o.prototype._importTemplates=function(){r.saveChartTemplates(this._fileData().templates),this.importTmplsOpened(!1),this._bindTemplates(),this.optionsState({text:"Gráficos importados",type:"info"})},o}));